
{% extends "layout.html" %}
{% block content %}
    <div class="chat-container">
        <h2>Chat with {{ other_user.username }}</h2>
        <div id="chat-messages">
            {% for message in messages %}
            <div class="message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}">
                <p>{{ message.content }}</p>
                <small>{{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
            </div>
            {% endfor %}
        </div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Type your message...">
            <button type="submit">Send</button>
        </form>
    </div>

    <ul class="users-list">
        {% for user in all_users %}
            {% if user.id != current_user.id %}
            <li>
                <a href="{{ url_for('private_chat', user_id=user.id) }}">
                    {{ user.username }}
                </a>
            </li>
            {% endif %}
        {% endfor %}
    </ul>


    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io.connect('http://' + document.domain + ':' + location.port);
        const userId = "{{ current_user.id }}";
        const receiverId = "{{ other_user.id }}";

        // Message form submission
        document.getElementById('message-form').onsubmit = function(e) {
            e.preventDefault();
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();

            if(message) {
                socket.emit('private_message', {
                    receiver_id: receiverId,
                    message: message
                });
                messageInput.value = '';
            }
        };

        // Receive new messages
        socket.on('new_message', function(data) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.sender === "{{ current_user.username }}" ? 'sent' : 'received'}`;

            messageDiv.innerHTML = `
                <p>${data.message}</p>
                <small>${new Date(data.timestamp).toLocaleString()}</small>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    </script>
{% endblock %}
